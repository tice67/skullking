<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull King Scorer</title>
    <style>
        /* ---------------------------------------------------- */
        /* CSS G√âN√âRAL & FILIGRANE */
        /* ---------------------------------------------------- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 10px; /* R√©duit le padding g√©n√©ral pour les petits √©crans */
            background-color: #f4f4f4;
            color: #333;
            /* FILIGRANE PIRATE - ASSUREZ-VOUS QUE LE NOM DU FICHIER EST CORRECT */
            background-image: url('pirate_filigrane.png'); 
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: 950px;
            opacity: 0.95; 
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95); 
            padding: 15px; /* R√©duit le padding du conteneur */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        h1, h2, h3 {
            color: #d9534f; 
            text-align: center;
            margin-top: 10px; /* Marge r√©duite */
        }
        /* ---------------------------------------------------- */
        /* √âL√âMENTS D'INTERFACE */
        /* ---------------------------------------------------- */
        button, .player-name-input, input[type="number"], .input-field {
            padding: 12px 10px; /* Padding vertical l√©g√®rement augment√© pour le toucher */
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em; /* Assure une taille de police lisible */
        }
        button {
            background-color: #5cb85c; 
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button.red { 
            background-color: #d9534f; 
            margin-bottom: 15px; 
        }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .section {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        /* ---------------------------------------------------- */
        /* TABLES RESPONSIVE */
        /* ---------------------------------------------------- */
        /* Conteneur de d√©filement pour les tableaux */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .score-table, .bidding-summary {
            width: 100%;
            min-width: 300px; /* Assure une largeur minimale */
            border-collapse: collapse;
            margin-top: 15px;
            table-layout: fixed; /* Fixe la disposition pour mieux g√©rer les largeurs */
        }
        /* Largeurs sp√©cifiques pour les colonnes du tableau des scores */
        #score-table thead tr th:nth-child(1) { width: 15%; } /* Rang */
        #score-table thead tr th:nth-child(2) { width: 55%; } /* Joueur */
        #score-table thead tr th:nth-child(3) { width: 30%; } /* Total */

        .score-table th, .score-table td, .bidding-summary th, .bidding-summary td {
            border: 1px solid #ddd;
            padding: 8px 3px; /* Padding r√©duit pour plus de place */
            text-align: center;
            overflow: hidden;
            white-space: nowrap; /* Emp√™che les retours √† la ligne */
            text-overflow: ellipsis; /* Ajoute des points de suspension si le texte est tronqu√© */
        }
        .score-table th, .bidding-summary th {
            background-color: #f2f2f2;
        }
        /* ---------------------------------------------------- */
        /* MODAL (POUR SAISIE D'UN JOUEUR) */
        /* ---------------------------------------------------- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); 
            display: none;
            justify-content: center;
            align-items: flex-start; /* Place le modal en haut pour √©viter qu'il soit coup√© par le clavier */
            z-index: 1000;
            padding-top: 20px;
        }
        .modal-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            width: 95%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 28px; 
            font-weight: bold;
            cursor: pointer;
            color: #d9534f;
        }
        .bonus-group {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }
        .bonus-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .bonus-field label {
            flex-grow: 1;
            font-size: 0.95em;
        }
        .bonus-field input[type="number"] {
            width: 55px; 
            text-align: center;
            padding: 5px;
        }
        .rascal-options label {
            margin-right: 10px;
            font-weight: normal;
            display: inline-block; 
        }
        .kraken-box {
            background-color: #ffcccc; 
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        /* ---------------------------------------------------- */
        /* CR√âDITS */
        /* ---------------------------------------------------- */
        .credits {
            text-align: center;
            font-size: 0.8em;
            color: #666;
            margin-top: 20px;
        }
        .credits a {
            color: #d9534f;
            text-decoration: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üëë Skull King Scorer</h1>

    <div id="setup-screen">
        <h2>D√©marrage de la partie</h2>
        <p>Entrez les noms des joueurs (minimum 2) :</p>
        <div id="player-names-container">
            <input type="text" class="player-name-input" placeholder="Joueur 1">
            <input type="text" class="player-name-input" placeholder="Joueur 2">
        </div>
        <button onclick="addPlayer()">+ Ajouter un joueur</button>
        <button onclick="startGame()">D√©marrer une nouvelle partie</button>
        <button id="load-game-btn" onclick="loadGame()" style="display:none; background-color: #337ab7;">Continuer la partie sauvegard√©e</button>
    </div>

    <div id="score-screen" style="display:none;">
        <h2 id="current-manche">Manche 1 / 10</h2>
        <div class="table-responsive">
            <table id="score-table" class="score-table">
                <thead>
                    <tr><th>Rang</th><th>Joueur</th><th>Total</th></tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <button onclick="startBidding()">D√©marrer les paris</button>
    </div>

    <div id="bidding-screen" style="display:none;">
        <h2>Saisie des Paris</h2>
        <p id="bidding-info"></p>
        <div id="bidding-inputs" class="section">
            </div>
        <button onclick="validateBids()">Valider les paris</button>
    </div>

    <div id="results-screen" style="display:none;">
        <h2>Saisie des R√©sultats (Manche <span id="manche-num-result"></span>)</h2>
        
        <div class="kraken-box">
             <label>
                <input type="checkbox" id="kraken-used" onchange="checkTotalPlisValidation()"> Le **Kraken** a √©t√© jou√© cette manche ?
            </label>
        </div>

        <p>Cliquez sur un joueur pour saisir ses plis et bonus.</p>
        <table class="bidding-summary">
            <thead>
                <tr><th>Joueur</th><th>Pari</th><th>Statut</th></tr>
            </thead>
            <tbody id="results-summary-body">
                </tbody>
        </table>
        
        <button onclick="goToBidding()" class="red">
            Modifier les paris de la manche
        </button>
        
        <button id="calculate-scores-btn" onclick="calculateScores()" disabled>Calculer et Terminer la Manche</button>
    </div>
</div>

<div class="credits">
    Con√ßu par GDD. 
    Gemini agissant ici comme assistant de d√©veloppement pour GDD.
</div>
<div id="player-details-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="closeModal(null)">&times;</span>
        <h3 id="modal-player-name"></h3>

        <div class="section">
            <h4>Plis r√©alis√©s (Max : <span id="modal-max-plis"></span>)</h4>
            <div class="bonus-field">
                <label for="modal-plis-realises">Plis faits :</label>
                <input type="number" id="modal-plis-realises" value="0" min="0">
            </div>
        </div>

        <div class="section">
            <h4>Bonus Bourse & √âv√©nements Sp√©ciaux</h4>

            <div class="bonus-group">
                <label>
                    <input type="checkbox" id="modal-harry-used" onchange="toggleHarryOptions()"> A jou√© **Harry le G√©ant** ?
                </label>
                <div id="modal-harry-options" style="margin-left: 20px;">
                    <p>Pari initial : <strong id="harry-initial-bid">0</strong></p>
                    <div class="bonus-field">
                        <label for="modal-harry-final-bid">Pari final (modification +/- 1) :</label> 
                        <input type="number" id="modal-harry-final-bid" min="0" max="0">
                    </div>
                </div>
            </div>
            
            <div class="bonus-group">
                <label>
                    <input type="checkbox" id="modal-rascal-used" onchange="toggleRascalOptions()"> A jou√© le **Rascal le Flambeur** ?
                </label>
                <div id="modal-rascal-options" class="rascal-options" style="display:none; margin-left: 20px;">
                    <p>Mise annonc√©e :</p>
                    <label><input type="radio" name="modal-rascal-bid" value="0" checked> +0 points</label>
                    <label><input type="radio" name="modal-rascal-bid" value="10"> +10 points</label>
                    <label><input type="radio" name="modal-rascal-bid" value="20"> +20 points</label>
                </div>
            </div>

            <div class="bonus-group">
                <h5>Captures (non compt√©es si pari rat√©)</h5>
                <div class="bonus-field">
                    <label>14 Standard (+10)</label>
                    <input type="number" id="modal-b14s" value="0" min="0">
                </div>
                <div class="bonus-field">
                    <label>14 Noir (+20)</label>
                    <input type="number" id="modal-b14n" value="0" min="0">
                </div>
                <div class="bonus-field">
                    <label>Bourse (+20)</label>
                    <input type="number" id="modal-bbourse" value="0" min="0">
                </div>
                <div class="bonus-field">
                    <label>Pirate captur√© (+30)</label>
                    <input type="number" id="modal-bpirate" value="0" min="0">
                </div>
                <div class="bonus-field">
                    <label>Sir√®ne captur√©e (+20)</label>
                    <input type="number" id="modal-bsirene" value="0" min="0">
                </div>
                <div class="bonus-field">
                    <label>Skull King captur√© (+40)</label>
                    <input type="number" id="modal-bskullking" value="0" min="0">
                </div>
            </div>
        </div>
        
        <button id="modal-save-btn" onclick="savePlayerResults()">Valider les r√©sultats de ce joueur</button>
    </div>
</div>

<script>
    // Variables globales
    let players = [];
    let currentManche = 1;
    let scores = {}; // { 'Nom': [scoreManche1, scoreManche2, ...], ... }
    let bids = {}; // { 'Nom': 1, 'Nom2': 0, ... } - Stocke le pari initial (du bidding-screen)
    let roundResults = {}; // Stocke temporairement les r√©sultats de la manche en cours

    const MAX_MANCHES = 10;
    const LOCAL_STORAGE_KEY = 'skullking_game_data';

    // --- Fonctions de Sauvegarde et Chargement ---

    /** Sauvegarde l'√©tat actuel du jeu dans localStorage. */
    function saveGame() {
        // Enregistrement de l'√©tat du Kraken dans la sauvegarde
        const krakenUsed = document.getElementById('kraken-used') ? document.getElementById('kraken-used').checked : false;
        
        const gameState = {
            players: players,
            currentManche: currentManche,
            scores: scores,
            roundResults: roundResults, 
            bids: bids,
            krakenUsed: krakenUsed // Sauvegarde l'√©tat du Kraken
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameState));
    }

    /** Charge et reprend une partie sauvegard√©e. */
    function loadGame() {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedData) {
            const gameState = JSON.parse(savedData);
            players = gameState.players;
            currentManche = gameState.currentManche;
            scores = gameState.scores;
            bids = gameState.bids;
            roundResults = gameState.roundResults || {};

            // D√©termine l'√©cran √† afficher
            if (currentManche > MAX_MANCHES) {
                alert("La partie est termin√©e ! Affichez le tableau des scores final.");
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('score-screen').style.display = 'block';
                updateScoreTable();
                return;
            } else if (Object.keys(bids).length === players.length && Object.keys(bids).length > 0) {
                 // Si les paris sont valid√©s, aller aux r√©sultats
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('results-screen').style.display = 'block';
                // Restauration de l'√©tat du Kraken
                if (document.getElementById('kraken-used')) {
                     document.getElementById('kraken-used').checked = gameState.krakenUsed || false;
                }
                setupResultsSummary();
                checkTotalPlisValidation(); 
            } else {
                // Sinon, retourner √† l'√©cran des scores pour la nouvelle manche
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('score-screen').style.display = 'block';
                updateScoreTable();
            }
            alert(`Partie reprise ! Manche ${currentManche}.`);

        } else {
            alert("Aucune partie sauvegard√©e trouv√©e.");
        }
    }

    /** V√©rifie s'il y a une partie sauvegard√©e au chargement de la page. */
    function checkSavedGame() {
        if (localStorage.getItem(LOCAL_STORAGE_KEY)) {
            document.getElementById('load-game-btn').style.display = 'block';
        }
    }

    /** Efface la sauvegarde. */
    function clearGame() {
        localStorage.removeItem(LOCAL_STORAGE_KEY);
    }

    // --- Fonctions d'Initialisation ---

    /** Ajoute un champ pour un nouveau joueur. */
    function addPlayer() {
        const container = document.getElementById('player-names-container');
        const count = container.querySelectorAll('.player-name-input').length + 1;
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'player-name-input';
        input.placeholder = `Joueur ${count}`;
        container.appendChild(input);
    }

    /** D√©marre une nouvelle partie. */
    function startGame() {
        const nameInputs = document.querySelectorAll('.player-name-input');
        players = [];
        nameInputs.forEach(input => {
            const name = input.value.trim();
            if (name.length > 0) {
                players.push(name);
            }
        });

        if (players.length < 2) {
            alert("Veuillez entrer au moins deux noms de joueurs.");
            return;
        }

        // R√©initialisation de toutes les variables pour une nouvelle partie
        currentManche = 1;
        scores = {};
        bids = {};
        roundResults = {};
        players.forEach(name => { scores[name] = []; });
        clearGame();

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('score-screen').style.display = 'block';
        updateScoreTable();
        saveGame(); 
    }

    // --- Fonctions de Navigation et d'Affichage ---

    /** Met √† jour l'affichage du tableau des scores, tri√© par score total d√©croissant. */
    function updateScoreTable() {
        
        // --- 1. Pr√©paration de l'affichage de la manche ---
        
        if (currentManche > MAX_MANCHES) {
            document.getElementById('current-manche').textContent = `Partie Termin√©e : ${MAX_MANCHES} Manches !`;
            document.querySelector('#score-screen button').textContent = "Afficher le Gagnant (Partie Termin√©e)";
        } else {
            document.getElementById('current-manche').textContent = `Manche ${currentManche} / ${MAX_MANCHES}`;
            document.querySelector('#score-screen button').textContent = "D√©marrer les paris";
        }
        
        // --- 2. Cr√©ation de la liste des joueurs avec leurs scores totaux ---
        
        const leaderboard = players.map(name => {
            const totalScore = scores[name].reduce((a, b) => a + b, 0);
            return { name: name, score: totalScore };
        });

        // --- 3. TRI du tableau des scores (Ordre D√©croissant) ---
        
        // 'b.score - a.score' pour le tri d√©croissant (meilleur score en premier)
        leaderboard.sort((a, b) => b.score - a.score); 

        // --- 4. Affichage du tableau HTML ---
        
        const tbody = document.querySelector('#score-table tbody');
        tbody.innerHTML = '';
        let rank = 1;
        let lastScore = null;
        
        leaderboard.forEach((playerData, index) => {
            
            // G√©rer les ex aequo pour l'affichage du rang
            if (playerData.score !== lastScore) {
                rank = index + 1;
            }
            lastScore = playerData.score;
            
            const row = tbody.insertRow(); 
            // Ajout des cellules Rang, Nom, Score Total
            row.insertCell().textContent = rank;
            row.insertCell().textContent = playerData.name;
            row.insertCell().textContent = playerData.score;
            
            // Mise en √©vidence du gagnant (ou des gagnants ex aequo) apr√®s la fin de la partie
            if (currentManche > MAX_MANCHES && rank === 1) {
                row.style.backgroundColor = '#dff0d8'; // Vert clair
                row.style.fontWeight = 'bold';
            }
        });
        
        // L'en-t√™te du tableau est maintenant statique dans le HTML
    }

    /** Permet de revenir √† l'√©cran des paris depuis les r√©sultats */
    function goToBidding() {
        if (!confirm("Attention : Revenir √† la saisie des paris annulera toutes les saisies de plis et bonus de cette manche. Les r√©sultats devront √™tre saisis √† nouveau. Continuer ?")) {
            return;
        }

        // Basculer d'√©cran
        document.getElementById('results-screen').style.display = 'none';

        // Appel de startBidding en mode r√©vision
        startBidding(true); 
        saveGame();
    }

    /** * Affiche l'√©cran des paris. 
     * @param {boolean} isRevisiting - Indique si on est en mode modification.
     */
    function startBidding(isRevisiting = false) {
        if (currentManche > MAX_MANCHES) {
            alert("La partie est termin√©e !");
            return;
        }

        if (!isRevisiting) {
            document.getElementById('score-screen').style.display = 'none';
        } else {
            // Si on revient en arri√®re, on r√©initialise l'√©tat de validation des r√©sultats et le Kraken
            roundResults = {}; 
            document.getElementById('kraken-used').checked = false;
        }
        
        document.getElementById('bidding-screen').style.display = 'block';

        const maxPlis = currentManche;
        document.getElementById('bidding-info').textContent = `Chaque joueur parie entre 0 et ${maxPlis} plis.`;
        const container = document.getElementById('bidding-inputs');
        container.innerHTML = '';

        players.forEach(name => {
            // Pr√©-remplit le champ avec le pari actuel, sinon 0
            const currentBid = bids[name] !== undefined ? bids[name] : 0; 

            const div = document.createElement('div');
            div.className = 'player-input';
            div.innerHTML = `
                <label for="bid-${name}">${name} :</label>
                <input type="number" id="bid-${name}" value="${currentBid}" min="0" max="${maxPlis}" class="input-field">
            `;
            container.appendChild(div);
        });
    }

    // --- Fonctions de Saisie et de Validation ---

    /** Valide les paris et passe √† l'√©cran de r√©sultats. */
    function validateBids() {
        bids = {}; 
        roundResults = {}; 
        let allValid = true;
        const maxPlis = currentManche;

        players.forEach(name => {
            const input = document.getElementById(`bid-${name}`);
            const bidValue = parseInt(input.value);

            if (isNaN(bidValue) || bidValue < 0 || bidValue > maxPlis) {
                alert(`${name}: Veuillez entrer un pari valide entre 0 et ${maxPlis}.`);
                allValid = false;
            } else {
                bids[name] = bidValue;
                // Initialisation des r√©sultats temporaires
                roundResults[name] = { 
                    bid: bidValue, 
                    plis: null, 
                    rascal: null, 
                    bonus: null,
                    harryUsed: false 
                };
            }
        });

        if (allValid) {
            document.getElementById('bidding-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            setupResultsSummary();
            checkTotalPlisValidation(); 
            saveGame(); 
        }
    }
    
    /** Configure la liste de r√©sum√© des r√©sultats (o√π l'on clique). */
    function setupResultsSummary() {
        document.getElementById('manche-num-result').textContent = currentManche;
        const tbody = document.getElementById('results-summary-body');
        tbody.innerHTML = '';
        let allCompleted = true;

        players.forEach(name => {
            const result = roundResults[name];
            const displayBid = result && result.bid !== undefined ? result.bid : bids[name]; 
            const isCompleted = result && result.plis !== null && result.bonus !== null;
            
            if (!isCompleted) {
                allCompleted = false;
            }

            const row = tbody.insertRow();
            row.className = `result-player-row ${isCompleted ? 'completed' : ''}`;
            row.onclick = () => openPlayerModal(name);

            row.insertCell().textContent = name;
            row.insertCell().textContent = displayBid; 
            row.insertCell().innerHTML = isCompleted ? `‚úÖ ${result.plis} plis` : '‚ùå Cliquable pour saisir';
        });

        document.getElementById('calculate-scores-btn').disabled = !allCompleted;
    }

    // --- Fonctions du Modal ---

    /** Ouvre le modal pour la saisie d'un joueur. */
    function openPlayerModal(name) {
        document.getElementById('modal-player-name').textContent = name;
        document.getElementById('modal-save-btn').dataset.player = name;
        
        const maxPlis = currentManche;
        document.getElementById('modal-max-plis').textContent = maxPlis;
        document.getElementById('modal-plis-realises').max = maxPlis;

        const result = roundResults[name];
        
        // Plis
        document.getElementById('modal-plis-realises').value = result && result.plis !== null ? result.plis : 0;

        // Harry le G√©ant
        const initialBid = bids[name]; 
        
        document.getElementById('modal-harry-used').checked = result && result.harryUsed;
        document.getElementById('harry-initial-bid').textContent = initialBid;
        
        const harryFinalBidInput = document.getElementById('modal-harry-final-bid');
        harryFinalBidInput.min = Math.max(0, initialBid - 1);
        harryFinalBidInput.max = Math.min(maxPlis, initialBid + 1);
        harryFinalBidInput.value = result && result.bid !== undefined ? result.bid : initialBid; 
        
        toggleHarryOptions();

        // Rascal
        const rascalUsed = result && result.rascal !== null;
        document.getElementById('modal-rascal-used').checked = rascalUsed;
        toggleRascalOptions();
        if (rascalUsed && result.rascal !== false) {
            const radio = document.querySelector(`input[name="modal-rascal-bid"]:checked`);
            if (radio && parseInt(radio.value) !== result.rascal) {
                 // S'assurer que le bouton radio correct est coch√© si le Rascal a √©t√© utilis√©
                 const correctRadio = document.querySelector(`input[name="modal-rascal-bid"][value="${result.rascal}"]`);
                 if(correctRadio) correctRadio.checked = true;
            }
        }

        // Bonus
        const b = result && result.bonus || {};
        document.getElementById('modal-b14s').value = b.b14s || 0;
        document.getElementById('modal-b14n').value = b.b14n || 0;
        document.getElementById('modal-bbourse').value = b.bbourse || 0;
        document.getElementById('modal-bpirate').value = b.bpirate || 0;
        document.getElementById('modal-bsirene').value = b.bsirene || 0;
        document.getElementById('modal-bskullking').value = b.bskullking || 0;
        
        document.getElementById('player-details-modal').style.display = 'flex';
    }

    /** Active/d√©sactive les options de mise du Rascal dans le modal. */
    function toggleRascalOptions() {
        const checkbox = document.getElementById('modal-rascal-used');
        const optionsDiv = document.getElementById('modal-rascal-options');
        optionsDiv.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    /** Active/d√©sactive les options de pari modifi√© d'Harry le G√©ant. */
    function toggleHarryOptions() {
        const checkbox = document.getElementById('modal-harry-used');
        const optionsDiv = document.getElementById('modal-harry-options');
        optionsDiv.style.display = checkbox.checked ? 'block' : 'none';
        
        document.getElementById('modal-harry-final-bid').disabled = !checkbox.checked;
    }

    /** Ferme le modal. */
    function closeModal(event) {
        if (event === null || event.target.id === 'player-details-modal' || event.target.classList.contains('modal-close')) {
            document.getElementById('player-details-modal').style.display = 'none';
        }
    }

    /** Sauvegarde les r√©sultats saisis dans le modal temporairement. */
    function savePlayerResults() {
        const name = document.getElementById('modal-save-btn').dataset.player;
        const plis = parseInt(document.getElementById('modal-plis-realises').value) || 0;
        const rascalUsed = document.getElementById('modal-rascal-used').checked;
        const harryUsed = document.getElementById('modal-harry-used').checked;
        
        let rascalValue = null;
        if (rascalUsed) {
            const rascalBid = document.querySelector('input[name="modal-rascal-bid"]:checked');
            rascalValue = rascalBid ? parseInt(rascalBid.value) : 0; 
        } else {
            rascalValue = false;
        }

        let finalBid = bids[name]; 
        if (harryUsed) {
            const harryInput = document.getElementById('modal-harry-final-bid');
            const modifiedBid = parseInt(harryInput.value);

            const initialBid = bids[name];
            const minAllowed = Math.max(0, initialBid - 1);
            const maxAllowed = Math.min(currentManche, initialBid + 1);

            if (modifiedBid >= minAllowed && modifiedBid <= maxAllowed) {
                finalBid = modifiedBid; 
            } else {
                alert(`Erreur: Le pari final pour Harry doit √™tre entre ${minAllowed} et ${maxAllowed}. Le pari n'a pas √©t√© modifi√©.`);
            }
        }
        
        const bonus = {
            b14s: parseInt(document.getElementById('modal-b14s').value) || 0,
            b14n: parseInt(document.getElementById('modal-b14n').value) || 0,
            bbourse: parseInt(document.getElementById('modal-bbourse').value) || 0,
            bpirate: parseInt(document.getElementById('modal-bpirate').value) || 0,
            bsirene: parseInt(document.getElementById('modal-bsirene').value) || 0,
            bskullking: parseInt(document.getElementById('modal-bskullking').value) || 0,
        };

        // Mise √† jour de roundResults
        roundResults[name] = roundResults[name] || {};
        roundResults[name].plis = plis;
        roundResults[name].rascal = rascalValue;
        roundResults[name].bonus = bonus;
        roundResults[name].harryUsed = harryUsed;
        roundResults[name].bid = finalBid; 

        closeModal(null);
        setupResultsSummary(); 
        checkTotalPlisValidation(); 
        saveGame(); 
    }
    
    /** V√©rifie si le total des plis r√©alis√©s correspond au num√©ro de la manche, ajust√© par le Kraken. */
    function checkTotalPlisValidation() {
        let totalPlisRealises = 0;
        let allPlisEntered = true;

        players.forEach(name => {
            if (roundResults[name] && roundResults[name].plis !== null) {
                totalPlisRealises += roundResults[name].plis;
            } else {
                allPlisEntered = false;
            }
        });

        // Ajustement pour le Kraken
        const krakenElement = document.getElementById('kraken-used');
        const krakenUsed = krakenElement ? krakenElement.checked : false;
        const plisAttendus = currentManche - (krakenUsed ? 1 : 0);
        
        const calculateButton = document.getElementById('calculate-scores-btn');

        // La validation finale de l'√©tape de r√©sultats n'a lieu que si tous les joueurs ont √©t√© saisis.
        if (allPlisEntered) {
            if (totalPlisRealises === plisAttendus) {
                calculateButton.disabled = false;
                calculateButton.textContent = `Calculer les scores de la Manche ${currentManche}`;
            } else {
                calculateButton.disabled = true;
                calculateButton.textContent = `Total plis: ${totalPlisRealises}/${plisAttendus}. Le total doit √™tre exact.`;
            }
        } else {
             calculateButton.disabled = true;
             calculateButton.textContent = 'Saisir tous les r√©sultats avant de calculer';
        }
        
        saveGame(); // Sauve l'√©tat du Kraken
    }

    // --- Logique de Calcul des Scores ---

    /** Calcule et enregistre les scores de la manche. */
    function calculateScores() {
        const mancheScores = {};
        let summary = `R√©sultats de la Manche ${currentManche} :\n`;
        
        players.forEach(name => {
            const data = roundResults[name];
            const pari = data.bid; 
            const fait = data.plis;
            let scoreBase = 0;
            let bonusScore = 0;
            let rascalScore = 0; 

            const contratReussi = (pari === fait);

            // -----------------------------------------------------------------
            // 1. Calcul de la BASE (Score standard)
            // -----------------------------------------------------------------

            if (contratReussi) {
                // Pari r√©ussi
                if (pari === 0) {
                    scoreBase = currentManche * 10; // Pari 0 r√©ussi
                } else {
                    scoreBase = pari * 20; // Pari > 0 r√©ussi
                }
            } else {
                // Pari rat√©
                if (pari === 0) {
                    // CORRECTION ERREUR 1: Pari 0 rat√©
                    scoreBase = currentManche * -10; // P√©nalit√©: -10 points par carte
                } else {
                    // Pari > 0 rat√©
                    const difference = Math.abs(pari - fait);
                    scoreBase = difference * -10; // P√©nalit√©: -10 points par √©cart
                }
            }

            // -----------------------------------------------------------------
            // 2. Calcul du MODIFICATEUR RASCAL (Majoration/Minoration)
            // -----------------------------------------------------------------
            if (data.rascal !== false) {
                const mise = data.rascal;
                if (contratReussi) {
                    rascalScore = mise; 
                } else {
                    rascalScore = -mise; 
                }
            }
            
            // -----------------------------------------------------------------
            // 3. Calcul des BONUS (uniquement si contrat r√©ussi)
            // -----------------------------------------------------------------
            if (contratReussi) {
                const b = data.bonus;
                
                bonusScore += b.b14s * 10;
                bonusScore += b.b14n * 20;
                
                // La bourse n'est pas un pli, elle est seulement un bonus de capture.
                bonusScore += b.bbourse * 20; 
                
                bonusScore += b.bpirate * 30; 
                bonusScore += b.bsirene * 20; 
                bonusScore += b.bskullking * 40; 
            } 

            // -----------------------------------------------------------------
            // 4. Score Total : Base + Bonus + Rascal
            // -----------------------------------------------------------------
            const totalMancheScore = scoreBase + bonusScore + rascalScore;
            mancheScores[name] = totalMancheScore;

            // Enregistrement et r√©sum√©
            scores[name].push(totalMancheScore);
            summary += `${name} : ${totalMancheScore} points (Pari: ${pari}, Plis: ${fait}, Base: ${scoreBase}, Bonus: ${bonusScore}, Rascal: ${rascalScore})\n`;
        });

        alert(summary);

        // Pr√©paration pour la manche suivante
        currentManche++;
        bids = {}; 
        roundResults = {}; 
        
        document.getElementById('results-screen').style.display = 'none';
        document.getElementById('score-screen').style.display = 'block';
        updateScoreTable();
        saveGame();
    }
    
    // Initialisation au chargement de la page
    window.onload = checkSavedGame;

</script>
</body>
</html>
